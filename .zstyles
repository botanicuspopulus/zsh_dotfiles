# Antidote
zstyle :plugin:zsh-completion-generator programs cat xattr

# Don't prompt for a huge list, page it!
unsetopt MENU_COMPLETE # Do not auto select the first completion entry
unsetopt LIST_AMBIGUOUS
unsetopt FLOWCONTROL
setopt AUTO_MENU # show completion menu on successive tab press
setopt COMPLETE_IN_WORD
setopt ALWAYS_TO_END

zmodload -i zsh/complist

zstyle ':antidote:bundle' file ${ZDOTDIR:-~}/.zplugins
zstyle ':antidote:static' file ${ZDOTDIR:-~}/.zplugins.zsh
zstyle ':antidote:bundle' use-friendly-names 'yes'
zstyle ':antidote:plugin:*' defer-options '-p'

bindkey -M menuselect '^o' accept-and-infer-next-history
zstyle ':completion:*:*:*:*:*' menu select

# Note these need functions to be defined
zstyle ':completion:*' completer _oldlist _expand _force_rehash _complete _match _approximate _ignored
zstyle ':completion:*:match:*' original only
# More errors allowed for large words and fewer for small words
zstyle ':completion:*:approximate:*' max-errors "reply=(  $((($#PREFIX + $#SUFFIX) / 3))  )"
zstyle ':completion:*:approximate*:*' prefix-needed false

zstyle ':completion:*' verbose yes
zstyle ':completion:*:descriptions' format '%B%d%b'
zstyle ':completion:*:messages' format '%d'
zstyle ':completion:*:warnings' format 'No matches for: %d'
zstyle ':completion:*' group-name ''

zstyle ':completion:*' list-dirs-first true
zstyle ':completion:*' menu true=long select=long

zstyle ':completion::complete:*' use-cache 1

# Allow completion to expand around [._-], for example:
# .z.d [TAB] -> .zsh.d
# m-s [TAB] -> markdown-soma
# M_A [TAB] -> Massive_Attack
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' file-sort modification
zstyle ':completion:*:exa' sort false
zstyle ':completion:*:git-checkout:*' sort false
zstyle ':completion:files' sort false

bindkey -M viins '\C-i' complete-word

zstyle ':zel:*-word-shell' word-style shell

zle -N forward-word-shell forwad-word-match
zle -N backward-word-shell backward-word-match

# Group completions by type (file, external command, etc)
zstyle ':completion:*:matches' group 'yes'

# generate descriptions with magic
zstyle ':completion:*' auto-description 'specify: %d'

zstyle ':completion:*:default' list-prompt '%S%M matches %s'

# Don't prompt for a huge list, menu it!
zstyle ':completion:*:default' menu 'select=0'

# Have the newer files last so I see them first
zstyle ':completion:*' file-sort modification reverse

# Color code completion!!!
zstyle ':completion:*' list-colors "=(#b) #([0-9]#)*=36=31"

# Don't tab complete hosts (slow and if you have ad-blockin in your hosts files annoying)
zstyle ':completion:*' hosts off

zstyle ':completion:*' list-separator 'ï˜½'

# disable named-directories autocompletion
zstyle ':completion:*:cd:*' tag-order local-directories directory-stack path-directories

# Seperate man page sections
zstyle ':completion:*:manuals' separate-sections true

# Errors format
zstyle ':completion:*:corrections' format '%B%d (errors %e)%b'
zstyle ':completion:*:correct:*' insert-unambiguous true
zstyle ':completion:*:correct:*' original true

# Don't complete stuff already on the line
zstyle ':completion::*:(rm|vi):*' ignore-line true

# make kill way awesome
zstyle ':completion:*:processes' command 'ps -au$USER -o pid,time,cmd|grep -v "ps -au$USER -o pid,time,cmd"'
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#)[ 0-9:]#([^ ]#)*=01;30=01;31=01;38'

# Case insensitive (all), partial-word and substring completion
if [[ "$CASE_SENSITIVE" = true ]]; then
  zstyle ':completion:*' matcher-list 'r:\=*' 'l:|=* r:|=*'
else
  if [[ "$HYPHEN_INSENSITIVE" = true ]]; then
    zstyle ':completion:*' matcher-list 'm:{a-zA-Z-_}={A-Za-z_-}' 'r:|=*' 'l:|=* r:|=*'
  else
    zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|=*' 'l:|=* r:|=*'
  fi
fi
unset CASE_SENSITIVE HYPHEN_INSENSITIVE

# Don't complete uninteresting users
zstyle ':completion:*:*:*:users' ignored-patterns \
         adm amanda apache at avahi avahi-autoipd beaglidx bin cacti canna \
         clamav daemon dbus distcache dnsmasq dovecot fax ftp games gdm \
         gkrellmd gopher hacluster haldaemon hal hsqldb ident junkbust kdm \
         ldap lp mail mailman mailnull man messagebus mldonkey mysql nagios \
         named netdump news nfsnobody nobody nscd ntp nut nx obsrun openvpn \
         operator pcap polkid postfix postgres privoxy pulse pvm quagga radvd \
         rpc rpcuser rpm rtkit scard shutdown squid sshd statd svn sync tftp \
         usbmux uucp vcsa wwwrun xfs '_*'

# Unless absolutely needed
zstyle '*' single-ignored show

if [[ $COMPLETION_WAITING_DOTS = true ]]; then
  expand-or-complete-with-dots() {
# Toggle line wrapping off and back on again
    [[ -n "$terminfo[rmam]" && -n "$terminfo[smam]" ]] && echoti rmam
    print -Pn "%{%F{red......%f%}"
    [[ -n "$terminfo[rmam]" && -n "$terminfo[smam]" ]] && echoti smam

    zle expand-or-complete
    zle redisplay
  }
  zle -N expand-or-complete-with-dots
  bindkey "^I" expand-or-complete-with-dots
fi

# fzf-tab
zstyle ':fzf-tab:complete:_zlua:*' query-string input # autocomplete only with zlua
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-preview 'ps --pid=$word -o cmd --no-headers -w -w'
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-flags '--preview-window=down:3:wrap'
zstyle ':fzf-tab:complete:kill:*' popup-pad 0 3 
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'exa -1 --color=always $realpath'
zstyle ':fzf-tab:complete:cd:*' popup-pad 30 0
zstyle ':fzf-tab:*' fzf-flags --color=bg+:23
zstyle ':fzf-tab:*' fzf-command ftb-tmux-popup
zstyle ':fzf-tab:*' switch-group ',' '.'

# Don't mess up url passing as arguments
zstyle ':urlglobber' url-other-schema

### Autosuggest settings
export ZSH_AUTOSUGGEST_USE_ASYNC=1
export ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=100

# Autosuggestions from history, if none use the completion engine
export ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# Accept autosuggestions with shift+tab - I use this EVERY day
bindkey '^I' complete-word        # tab         | complete
bindkey '^[[Z' autosuggest-accept # shift + tab | autosuggest

zstyle :zle:edit-command-line editor nvim

if [[ -r $DOTFILES/local/zsh/zstyles.local.zsh ]]; then
  . $DOTFILES/local/zsh/zstyles.local.zsh
fi
